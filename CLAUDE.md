# Claude 开发规范

本文档为 Claude AI 模型在 OBD 项目中的开发规范，确保代码质量、类型安全和开发流程的一致性。

---

## 🎯 项目概述

**OBD (Open Batch Processor)** - Dify 工作流批处理器

- **目标**: 批量调用 Dify API，处理 Excel 问答，对比答案并生成报告
- **技术栈**: Python 3.11+, pandas, requests, uv
- **架构**: 分层架构 + 模块化设计
- **开发模式**: TDD (测试驱动开发)

---

## 📁 项目结构规范

### 标准布局 (src-layout)

```
obd/
├── .spec/                           # 📖 项目文档目录
│   ├── README.md                     # 文档导航
│   ├── api.md                        # API 接口文档
│   ├── models.md                     # 数据模型文档
│   ├── processor.md                  # 批处理模块文档
│   ├── comparator.md                 # 答案对比模块文档
│   ├── architecture.md              # 架构设计文档
│   ├── setup.md                      # 安装配置指南
│   ├── quickstart.md                 # 快速开始指南
│   ├── examples.md                   # 使用示例
│   ├── testing-strategy.md          # 测试策略
│   ├── coding-standards.md           # 开发规范
│   └── troubleshooting.md            # 问题排查
│
├── src/                             # 🔧 源代码目录
│   └── obd/                         # 主包
│       ├── __init__.py               # 包初始化
│       ├── main.py                   # 🚨 程序入口 (严格类型检查)
│       ├── models.py                 # 📊 数据模型 (使用 dataclass)
│       ├── client/                   # 🌐 API 客户端模块
│       │   ├── __init__.py
│       │   └── dify_client.py        # Dify API 封装
│       ├── comparator/              # 🎯 答案对比模块
│       │   ├── __init__.py
│       │   └── answer_comparator.py  # 匹配算法实现
│       └── processor/                # 📦 批处理模块
│           ├── __init__.py
│           └── batch_processor.py    # 批处理核心逻辑
│
├── tests/                           # 🧪 测试目录 (与 src 平级)
│   ├── __init__.py
│   ├── conftest.py                  # pytest fixtures
│   ├── test_models.py               # 模型测试
│   ├── test_client.py               # 客户端测试
│   ├── test_comparator.py            # 对比器测试
│   ├── test_processor.py             # 处理器测试
│   └── test_integration.py          # 集成测试
│
├── scripts/                         # 📝 脚本目录
├── data/                            # 📁 数据目录
├── config.ini                       # ⚙️ 配置文件 (gitignore)
├── config.ini.example              # 📄 配置模板
├── requirements.txt                # 📦 依赖列表
├── pyproject.toml                   # 🔧 项目配置
├── pytest.ini                      # 🧪 pytest 配置
├── .gitignore                      # 🚫 Git 忽略规则
├── README.md                       # 📖 项目说明
└── CLAUDE.md                       # 🤖 Claude 规范 (本文件)
```

---

## 🔧 类型系统规范

### 1. 严格类型注解

**所有公共接口必须使用类型注解**：

- 数据模型使用 `@dataclass` 和完整类型注解
- 函数参数和返回值都要明确类型
- 使用 `Optional` 表示可选参数
- 复杂类型使用 `Dict`, `List`, `Union` 等

### 2. 类型安全原则

- 编译时类型检查 (MyPy)
- 运行时类型验证
- 避免使用 `Any` 类型
- 使用泛型提高代码复用性

### 3. 数据模型设计

- 使用 `@dataclass` 简化数据类定义
- 所有字段都要有明确的类型注解
- 必需字段使用具体类型，可选字段使用 `Optional`
- 提供数据验证方法

---

## 🏗️ 模块架构规范

### 1. 分层架构原则

**应用层 (main.py)**:
- 程序入口和配置管理
- 错误处理和用户交互
- 依赖注入和组件组装

**业务逻辑层 (processor/)**:
- 核心业务流程编排
- 状态管理和事务控制
- 结果计算和统计

**服务层 (client/, comparator/)**:
- 专业服务组件
- 单一职责原则
- 可复用的功能模块

**数据层 (models.py)**:
- 数据结构定义
- 类型安全保证
- 序列化和反序列化

### 2. 模块间交互

- **依赖注入**: 通过构造函数注入依赖
- **接口隔离**: 定义清晰的协议和抽象类
- **松耦合**: 模块间通过接口交互
- **高内聚**: 相关功能集中在同一模块

### 3. 错误处理策略

- **分层错误处理**: 每层处理自己的异常
- **自定义异常**: 定义项目特定的异常类型
- **错误传播**: 向上传递关键错误信息
- **优雅降级**: 错误情况下的备用方案

---

## 🧪 测试驱动开发规范

### 1. 测试结构

**测试目录与 src 平级**:
- 使用 `tests/` 目录而非 `src/tests/`
- 测试文件与源文件对应
- 使用统一的测试命名规范

**测试类型覆盖**:
- **单元测试**: 测试单个组件
- **集成测试**: 测试组件间交互
- **API测试**: 测试外部服务调用
- **端到端测试**: 测试完整业务流程

### 2. TDD 开发流程

**红 → 绿 → 重构** 循环:

1. **红色阶段**: 编写失败的测试，明确需求
2. **绿色阶段**: 编写最少代码让测试通过
3. **重构阶段**: 优化代码结构，保持测试通过

### 3. 测试质量要求

- **测试覆盖率**: ≥ 80%
- **测试独立性**: 测试间不相互依赖
- **测试可读性**: 测试代码要清晰易懂
- **测试维护性**: 易于修改和扩展

---

## 📝 代码质量规范

### 1. 编码风格

- **格式化工具**: 使用 Black 自动格式化
- **代码检查**: 使用 Ruff 进行静态分析
- **类型检查**: 使用 MyPy 进行类型检查
- **命名规范**: 遵循 PEP 8 标准

### 2. 设计原则应用

- **SOLID 原则**: 单一职责、开闭原则等
- **DRY 原则**: 避免代码重复
- **KISS 原则**: 保持简单直接
- **YAGNI 原则**: 不做过度设计

### 3. 文档规范

- **模块文档**: 说明模块的职责和功能
- **类文档**: 说明类的用途和接口
- **方法文档**: 说明参数和返回值
- **更新日志**: 记录版本变更历史

---

## 🔧 开发工具配置

### 1. 代码质量工具

```toml
# pyproject.toml 配置
[tool.black]
line-length = 88
target-version = ['py311']

[tool.ruff]
line-length = 88
target-version = "py311"
select = ["E", "W", "F", "I", "B", "C4", "UP"]

[tool.mypy]
python_version = "3.11"
warn_return_any = true
disallow_untyped_defs = true
```

### 2. 测试配置

```toml
# pytest.ini 配置
[tool:pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts = -v --tb=short
```

### 3. 依赖管理

- 使用 `uv` 进行包管理
- 开发和生产依赖分离
- 定期更新依赖版本
- 安全漏洞扫描

---

## 🚀 开发工作流

### 1. 版本控制策略

**分支管理**:
- `main`: 主分支，保持稳定
- `develop`: 开发分支，集成最新功能
- `feature/*`: 功能分支
- `hotfix/*`: 紧急修复分支
- `release/*`: 发布准备分支

**提交规范**:
- 使用语义化提交信息
- 包含详细的变更描述
- 关联相关的问题编号
- 遵循 Conventional Commits

### 2. 代码审查流程

**审查要点**:
- 代码质量和风格规范
- 测试覆盖率和质量
- 架构设计和模块职责
- 错误处理和边界情况
- 性能和安全性考虑

**自动化检查**:
- CI/CD 流水线集成
- 代码格式化检查
- 单元测试运行
- 类型检查验证

### 3. 发布管理

**版本规范**: 语义化版本 (v1.0.0)
**发布流程**:
1. 功能开发完成
2. 测试验证通过
3. 文档更新完成
4. 版本标签创建
5. 发布说明生成

---

## 📊 性能和监控

### 1. 性能优化原则

- **测量优先**: 使用性能分析工具确定瓶颈
- **渐进优化**: 小步改进，持续测试
- **内存管理**: 及时释放资源，避免内存泄漏
- **并发控制**: 合理使用多线程和异步

### 2. 监控指标

- **处理速度**: 行/分钟、请求/秒
- **资源使用**: CPU、内存、磁盘 I/O
- **错误率**: 失败请求百分比
- **响应时间**: 平均和最大响应时间

### 3. 日志规范

- **结构化日志**: 使用 JSON 格式
- **日志级别**: DEBUG、INFO、WARNING、ERROR
- **敏感信息**: 不记录密码和密钥
- **日志轮转**: 定期清理和归档

---

## 🔒 安全考虑

### 1. 配置安全

- 敏感配置使用环境变量
- 配置文件加入 .gitignore
- 提供配置模板示例
- 定期轮换 API 密钥

### 2. 数据安全

- 输入验证和清理
- 输出编码和转义
- 加密敏感数据
- 安全的数据传输

### 3. 代码安全

- 避免安全漏洞 (XSS、SQL注入等)
- 使用安全的第三方库
- 定期安全审计
- 安全代码审查

---

## 📈 项目演进

### 1. 技术债务管理

- 识别和记录技术债务
- 制定偿还计划
- 权衡短期收益和长期健康
- 定期重构优化

### 2. 文档维护

- 文档与代码同步更新
- 保持文档的准确性和时效性
- 收集用户反馈改进文档
- 建立文档审查流程

### 3. 社区协作

- 开放的问题和讨论渠道
- 贡献指南和代码规范
- 版本发布说明
- 用户反馈收集机制

---

## 📞 开发支持

### 1. 问题排查

- 提供详细的错误信息和日志
- 使用调试工具和性能分析
- 参考文档和常见问题
- 社区讨论和经验分享

### 2. 持续学习

- 关注技术发展趋势
- 学习最佳实践和设计模式
- 参与开源社区
- 分享经验和知识

### 3. 工具和资源

- 开发环境搭建指南
- 调试和测试工具使用
- 代码生成和自动化工具
- 设计和架构参考资源

---

## 📝 更新日志

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| v0.1.0 | 2025-12-29 | 初始版本，定义开发规范 |
| v0.1.1 | 2025-12-29 | 完善TDD规范和类型系统要求 |
| v0.2.0 | 2025-12-29 | 重构为概述性规范，增强可维护性 |

---

**重要**: 本文档会随着项目发展持续更新，请定期查看最新版本。规范的重点是提供原则性指导，而非具体的实现细节，以保持代码的灵活性和可维护性。